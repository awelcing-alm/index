// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // pooler :6543
  directUrl = env("DIRECT_URL") // direct :5432 for migrate
}

/**
 * ============================================================
 * ACCOUNTS / USERS / MEMBERSHIP (Zephr-aligned, multi-tenant)
 * ============================================================
 */

model Account {
  id              String  @id @default(uuid()) @db.Uuid
  external_id     String  @unique @db.VarChar(255) // Zephr account id
  name            String  @db.VarChar(255)
  email_address   String? @db.VarChar(255)
  number_of_seats Int?
  tenant_id       String? @db.VarChar(255)

  users       UserAccount[]
  groups      Group[]
  grants      AccountGrant[]
  templates   Template[] // <— back relation for Template.account
  memberships GroupMembership[] // <— back relation for GroupMembership.account

  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  @@index([external_id], map: "acct_by_external_id")
}

model User {
  id             String   @id @default(uuid()) @db.Uuid
  external_id    String   @unique @db.VarChar(255) // Zephr user id
  email          String   @db.VarChar(320)
  attributes     Json?    @default("{}")
  email_verified Boolean? @default(false)

  firstname      String?   @db.VarChar(255)
  lastname       String?   @db.VarChar(255)
  role           String?   @db.VarChar(50)
  status         String?   @db.VarChar(50)
  last_login     DateTime? @db.Timestamptz(6)
  last_synced_at DateTime? @db.Timestamptz(6)

  accounts       UserAccount[]
  memberships    GroupMembership[] // <— back relation for GroupMembership.user
  newsletterSubs UserNewsletter[]

  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  @@index([email], map: "user_by_email")
  @@index([external_id], map: "user_by_external")
}

model UserAccount {
  user_id    String  @db.Uuid
  account_id String  @db.Uuid
  role       String? @db.VarChar(50)
  status     String? @db.VarChar(50)

  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@id([user_id, account_id])
  @@index([account_id, user_id], map: "ua_by_account_user")
}

model Group {
  id                  String  @id @default(uuid()) @db.Uuid
  account_id          String  @db.Uuid
  slug                String
  name                String
  icon                String? @db.VarChar(32)
  color               String? @db.VarChar(7)
  demographics        Json    @default("{}")
  default_template_id String? @db.Uuid
  user_count          Int     @default(0)

  account          Account           @relation(fields: [account_id], references: [id], onDelete: Cascade)
  // Named relation on BOTH sides:
  default_template Template?         @relation("Group_default_template", fields: [default_template_id], references: [id], onDelete: SetNull)
  memberships      GroupMembership[]

  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  @@unique([account_id, slug], map: "group_slug_per_account")
  @@index([account_id], map: "group_by_account")
}

model GroupMembership {
  // Single membership per (account, user_external_id)
  account_id       String @db.Uuid
  user_external_id String @db.VarChar(255) // references User.external_id (unique)
  group_id         String @db.Uuid

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade) // back: Account.memberships
  user    User    @relation(fields: [user_external_id], references: [external_id], onDelete: Cascade) // back: User.memberships
  group   Group   @relation(fields: [group_id], references: [id], onDelete: Cascade)

  assigned_by String?
  assigned_at DateTime @default(now()) @db.Timestamptz(6)

  @@id([account_id, user_external_id])
  @@index([group_id], map: "gm_by_group")
  @@index([user_external_id], map: "gm_by_user_external")
}

model Newsletter {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @unique @db.VarChar(255)
  description String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)

  subscribers UserNewsletter[]
}

model UserNewsletter {
  user_id       String    @db.Uuid
  newsletter_id String    @db.Uuid
  subscribed    Boolean   @default(true)
  open_rate     Decimal?  @default(0) @db.Decimal(5, 2)
  click_rate    Decimal?  @default(0) @db.Decimal(5, 2)
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  updated_at    DateTime? @default(now()) @db.Timestamptz(6)

  user       User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  newsletter Newsletter @relation(fields: [newsletter_id], references: [id], onDelete: Cascade)

  @@id([user_id, newsletter_id])
  @@index([newsletter_id], map: "un_by_newsletter")
}

model Product {
  id               String  @id @default(uuid()) @db.Uuid
  zephr_product_id String  @unique @db.VarChar(255)
  label            String  @db.VarChar(255)
  description      String?

  grants AccountGrant[]

  created_at DateTime? @default(now()) @db.Timestamptz(6)
}

model Entitlement {
  id                   String  @id @default(uuid()) @db.Uuid
  zephr_entitlement_id String  @unique @db.VarChar(255)
  label                String?
  description          String?
  type                 String? @db.VarChar(50)

  grants AccountGrant[]

  created_at DateTime? @default(now()) @db.Timestamptz(6)
}

model AccountGrant {
  id             String  @id @default(uuid()) @db.Uuid
  account_id     String  @db.Uuid
  product_id     String? @db.Uuid
  entitlement_id String? @db.Uuid

  zephr_grant_id String    @unique @db.VarChar(255)
  expiry_state   String?   @db.VarChar(50)
  start_time     DateTime? @db.Timestamptz(6)
  end_time       DateTime? @db.Timestamptz(6)

  account     Account      @relation(fields: [account_id], references: [id], onDelete: Cascade)
  product     Product?     @relation(fields: [product_id], references: [id], onDelete: SetNull)
  entitlement Entitlement? @relation(fields: [entitlement_id], references: [id], onDelete: SetNull)

  @@index([account_id], map: "grant_by_account")
  @@index([product_id], map: "grant_by_product")
  @@index([entitlement_id], map: "grant_by_entitlement")
}

model AttributeDefinition {
  slug           String   @id
  label          String?
  input_type     String?
  required       Boolean? @default(false)
  select_options Json?
}

model Template {
  id          String  @id @default(uuid()) @db.Uuid
  account_id  String  @db.Uuid
  name        String
  description String?
  attributes  Json    @default("{}")

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade) // back: Account.templates
  groups  Group[] @relation("Group_default_template") // back: Group.default_template

  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  @@unique([account_id, name], map: "template_name_per_account")
  @@index([account_id], map: "template_by_account")
}
